<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>CYBER DRAGON ‚Äî Menu</title>
  <link rel="icon" href="logo.png"/>
  <link rel="stylesheet" href="base.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="bar">
        <h1 class="brand" id="brandTap">cyber dragon <img class="mark" src="logo.png" alt="Logo"> 90s</h1>
        <div class="lang">
          <select id="langSel" aria-label="Language">
            <option value="ru">üá∑üá∫ RU</option>
            <option value="ua">üá∫üá¶ UA</option>
            <option value="vn">üáªüá≥ VN</option>
          </select>
        </div>
        <button class="burger" id="burgerBtn" aria-haspopup="true" aria-expanded="false" aria-controls="navPop">‚ò∞</button>
        <nav class="nav-pop" id="navPop" role="menu" aria-label="Main menu">
          <a href="index.html" id="navHome" role="menuitem">üè† HOME</a>
          <a href="#" id="navMenu" role="menuitem">üçú MENU</a>
          <a href="#" id="navKaraoke" role="menuitem">üé§ KARAOKE</a>
          <a href="#" id="navContact" role="menuitem">üìû CONTACT</a>
          <hr>
          <div class="lang-inline" role="none">üåê
            <select id="langSelMenu" aria-label="Language (menu)">
              <option value="ru">üá∑üá∫ RU</option>
              <option value="ua">üá∫üá¶ UA</option>
              <option value="vn">üáªüá≥ VN</option>
            </select>
          </div>
        </nav>
      </div>
    </header>
    <div class="hero">
      <video
        class="promo"
        src="promo.mp4"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      ></video>
        MENU
      </button>
      <div class="social">
        <a href="https://www.facebook.com/" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
          <img src="images/icon/fb.png" alt="Facebook">
        </a>
        <a href="https://www.instagram.com/cyber_dragon_ua/" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <img src="images/icon/ig.png" alt="Instagram">
        </a>
        <a href="https://www.whatsapp.com/?lang=ru_RU" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
          <img src="images/icon/wa.png" alt="WhatsApp">
        </a>
        <a href="https://www.tiktok.com/" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
          <img src="images/icon/tt.png" alt="TikTok">
        </a>
      </div>
     
    </div>
    <!-- Category pills -->
    <nav class="cat-nav glass-nav">
      <div class="h-scroll" id="catPills" aria-label="Categories"></div>
    </nav>
    <!-- Top tools: search + order status -->
    <div class="top-tools">
      <div class="searchbar glass">
        <span class="icon">üîé</span>
        <input id="searchIn" type="search" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞ / Search‚Ä¶" autocomplete="off" />
        <button class="icon-btn" id="searchClear" aria-label="Clear">‚úï</button>
      </div>
      <div class="statusbar glass">
        <span class="icon">üì¶</span>
        <input id="statusCode" type="text" placeholder="–ö–æ–¥ –∑–∞–∫–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, a123)" autocomplete="off" />
        <button class="btn mini" id="statusBtn">–°—Ç–∞—Ç—É—Å</button>
      </div>
      <div class="status-result" id="statusResult" aria-live="polite"></div>
    </div>
    <main id="content"></main>
    <!-- All categories sheet -->
    <div class="overlay" id="catOverlay"></div>
    <div class="sheet" id="catSheet" role="dialog" aria-modal="true" aria-labelledby="catSheetTitle">
      <div class="sheet-handle" aria-hidden="true"></div>
      <button class="sheet-close" id="catSheetClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 id="catSheetTitle">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
      <div class="group" id="catSheetList"></div>
    </div>
    <!-- iOS-style Bottom Dock -->
    <nav class="dock" aria-label="Bottom navigation">
      <button class="dock-btn" id="dockCat" data-label="Menu">
        <img src="DockIconMenu.png" alt="Menu">
      </button>
      <button class="dock-btn" id="dockLang" data-label="Lang">
        <img src="DockIconLang.png" alt="Language">
        <span class="cart-badge" id="dockLangFlag">üá∫üá¶</span>
      </button>
      <button class="dock-btn" id="dockCart" data-label="Cart">
        <img src="DockIconKorzina.png" alt="Cart">
        <span class="cart-badge" id="cartBadge">0</span>
      </button>
      <button class="dock-btn" id="dockView" data-label="View">
        <img src="DockIconWien.png" alt="View">
      </button>
      <button class="dock-btn" id="dockMore" data-label="More">
        <img src="DockIconMore.png" alt="More">
      </button>
    </nav>
    <!-- Mini language popup -->
    <div class="mini-popup mini-popup-lang" id="langPopup">
      <button data-lang="ru">üá∫üá¶ RU</button>
      <button data-lang="ua">üá∫üá¶ UA</button>
      <button data-lang="vn">üáªüá≥ VN</button>
    </div>
    <!-- Cart Bottom Sheet -->
    <div class="overlay" id="overlay"></div>
    <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet-handle" aria-hidden="true"></div>
      <button class="sheet-close" id="sheetClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 id="sheetTitle">–í–∞—à –∑–∞–∫–∞–∑</h3>
      <div class="cart-lines" id="cartLines"></div>
      <div class="section">
        <div class="muted" id="orderTypeTitle" style="margin-bottom:6px">–¢–∏–ø –∑–∞–∫–∞–∑–∞</div>
        <div class="group" id="orderType">
          <button class="chip active" data-ot="on_site" id="otOnSite">–ù–∞ –º–µ—Å—Ç–µ</button>
          <button class="chip" data-ot="takeaway" id="otTakeaway">–ù–∞ –≤—ã–Ω–æ—Å</button>
          <button class="chip" data-ot="delivery" id="otDelivery">–î–æ—Å—Ç–∞–≤–∫–∞</button>
        </div>
        <div class="field" id="tableField" style="display:grid">
          <label for="tableNo" id="tableLbl">–°—Ç–æ–ª <span class="muted" id="tableHint">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input id="tableNo" type="number" min="1" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 5">
        </div>
        <div class="field" id="takeawayField" style="display:none">
          <label for="pickupIn" id="pickupLbl">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∑–∞–±—Ä–∞—Ç—å (–º–∏–Ω) <span class="muted" id="pickupHint">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input id="pickupIn" type="number" min="5" step="5" placeholder="15">
        </div>
        <div class="field" id="addrField" style="display:none">
          <label for="address" id="addrLbl">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="muted" id="addrHint">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <textarea id="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥..."></textarea>
        </div>
        <div class="field" id="phoneField">
          <label for="phone" id="phoneLbl">–¢–µ–ª–µ—Ñ–æ–Ω <span class="muted" id="phoneHint">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input id="phone" type="tel" placeholder="+380 63 000 00 00">
        </div>
      </div>
      <div class="checkout">
        <div class="muted" id="cartMeta">–ò—Ç–æ–≥–æ: 0.00 –≥—Ä–Ω</div>
        <button class="btn primary" id="checkoutBtn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        <button class="btn ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
    <!-- Dish Details Sheet -->
    <div class="overlay" id="dishOverlay"></div>
    <div class="sheet dish-sheet" id="dishSheet" role="dialog" aria-modal="true" aria-labelledby="dishTitle">
      <div class="sheet-handle" aria-hidden="true"></div>
      <button class="sheet-close" id="dishClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div class="dish-head">
        <div class="dish-title">
          <h3 id="dishTitle">‚Äî</h3>
          <div class="muted" id="dishSub">‚Äî</div>
        </div>
        <div class="dish-price" id="dishPrice">0.00 –≥—Ä–Ω</div>
      </div>
      <div class="dish-media" id="dishMedia"></div>
      <div class="dish-body">
        <div class="dish-desc" id="dishDesc">‚Äî</div>
        <div class="dish-options" id="dishOptions"></div>
        <div class="dish-note">
          <label for="dishNote" class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="dishNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ –ª—É–∫–∞, –±–æ–ª—å—à–µ —Å–æ—É—Å–∞‚Ä¶"></textarea>
        </div>
      </div>
      <div class="dish-actions">
        <button class="btn ghost" id="dishMinus">‚àí</button>
        <div class="dish-qty" id="dishQty">0</div>
        <button class="btn ghost" id="dishPlus">+</button>
        <button class="btn primary" id="dishAddBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
    <!-- DATA -->
    <script src="menu.js"></script>
    <script>
    /* ==== LANG & I18N ==== */
    const LANG_KEY = 'CD_LANG';
    let LANG = localStorage.getItem(LANG_KEY) || 'ru';
    document.documentElement.lang = LANG;
    const LANGS_ORDER = ['ru','ua','vn'];
    const LANG_FLAGS = { ru:'üá∫üá¶', ua:'üá∫üá¶', vn:'üáªüá≥' };
    // === Google Sheets API (Apps Script) ===
    const API_BASE = "https://script.google.com/macros/s/AKfycbywwekrmdJvCnKuXKXY-D1_fkJDNm6ES9xAsptqRpoCOS6u9QidiSnGizIK0wybcGTl/exec";
    const I18N = {
      ru:{
        navHome:'–ì–ª–∞–≤–Ω–∞—è',navMenu:'–ú–µ–Ω—é',navKaraoke:'–ö–∞—Ä–∞–æ–∫–µ',navContact:'–ö–æ–Ω—Ç–∞–∫—Ç—ã',
        ui:{add:'–î–æ–±–∞–≤–∏—Ç—å',more:'–ü–æ–¥—Ä–æ–±–Ω–µ–µ',itemsShort:'—à—Ç.',viewList:'–í–∏–¥ —Å–ø–∏—Å–∫–æ–º',viewGrid:'–í–∏–¥ —Å–µ—Ç–∫–æ–π'},
        sheet:{
          title:'–í–∞—à –∑–∞–∫–∞–∑',empty:'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.',orderType:'–¢–∏–ø –∑–∞–∫–∞–∑–∞',
          onSite:'–ù–∞ –º–µ—Å—Ç–µ',takeaway:'–ù–∞ –≤—ã–Ω–æ—Å',delivery:'–î–æ—Å—Ç–∞–≤–∫–∞',
          table:'–°—Ç–æ–ª',pickupIn:'–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∑–∞–±—Ä–∞—Ç—å (–º–∏–Ω)',address:'–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏',phone:'–¢–µ–ª–µ—Ñ–æ–Ω',
          phTable:'–ù–∞–ø—Ä–∏–º–µ—Ä, 5',phPickup:'15',phAddress:'–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥...',phPhone:'+380 63 000 00 00',
          total:'–ò—Ç–æ–≥–æ',checkout:'–û—Ñ–æ—Ä–º–∏—Ç—å',clear:'–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É',
          errTable:'–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞.',errPickup:'–£–∫–∞–∂–∏—Ç–µ —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–±—Ä–∞—Ç—å.',
          errPhone:'–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω.',errAddress:'–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.'
        },
        common:{required:'(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',optional:'(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)'},
        tabbar:{menu:'–ú–µ–Ω—é',lang:'–Ø–∑—ã–∫',cart:'–ö–æ—Ä–∑–∏–Ω–∞',more:'–ï—â—ë'}
      },
      ua:{
        navHome:'–ì–æ–ª–æ–≤–Ω–∞',navMenu:'–ú–µ–Ω—é',navKaraoke:'–ö–∞—Ä–∞–æ–∫–µ',navContact:'–ö–æ–Ω—Ç–∞–∫—Ç–∏',
        ui:{add:'–î–æ–¥–∞—Ç–∏',more:'–î–æ–∫–ª–∞–¥–Ω—ñ—à–µ',itemsShort:'—à—Ç.',viewList:'–í–∏–≥–ª—è–¥ —Å–ø–∏—Å–∫–æ–º',viewGrid:'–í–∏–≥–ª—è–¥ —Å—ñ—Ç–∫–æ—é'},
        sheet:{
          title:'–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è',empty:'–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π.',orderType:'–¢–∏–ø –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è',
          onSite:'–£ –∑–∞–∫–ª–∞–¥—ñ',takeaway:'–ù–∞ –≤–∏–Ω—ñ—Å',delivery:'–î–æ—Å—Ç–∞–≤–∫–∞',
          table:'–°—Ç—ñ–ª',pickupIn:'–ß–µ—Ä–µ–∑ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–±—Ä–∞—Ç–∏ (—Ö–≤)',address:'–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏',phone:'–¢–µ–ª–µ—Ñ–æ–Ω',
          phTable:'–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 5',phPickup:'15',phAddress:'–ú—ñ—Å—Ç–æ, –≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫‚Ä¶',phPhone:'+380 63 000 00 00',
          total:'–†–∞–∑–æ–º',checkout:'–û—Ñ–æ—Ä–º–∏—Ç–∏',clear:'–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫',
          errTable:'–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Å—Ç–æ–ª—É.',errPickup:'–í–∫–∞–∂—ñ—Ç—å —á–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è (—Ö–≤).',
          errPhone:'–í–∫–∞–∂—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω.',errAddress:'–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏.'
        },
        common:{required:'(–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)',optional:'(–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)'},
        tabbar:{menu:'–ú–µ–Ω—é',lang:'–ú–æ–≤–∞',cart:'–ö–æ—à–∏–∫',more:'–©–µ'}
      },
      vn:{
        navHome:'Trang ch·ªß',navMenu:'Th·ª±c ƒë∆°n',navKaraoke:'Karaoke',navContact:'Li√™n h·ªá',
        ui:{add:'Th√™m',more:'Chi ti·∫øt',itemsShort:'m√≥n',viewList:'D·∫°ng danh s√°ch',viewGrid:'D·∫°ng l∆∞·ªõi'},
        sheet:{
          title:'ƒê∆°n h√†ng c·ªßa b·∫°n',empty:'Gi·ªè h√†ng tr·ªëng.',orderType:'H√¨nh th·ª©c ƒë·∫∑t',
          onSite:'ƒÇn t·∫°i ch·ªó',takeaway:'Mang ƒëi',delivery:'Giao h√†ng',
          table:'B√†n',pickupIn:'Nh·∫≠n sau (ph√∫t)',address:'ƒê·ªãa ch·ªâ giao h√†ng',phone:'ƒêi·ªán tho·∫°i',
          phTable:'V√≠ d·ª•: 5',phPickup:'15',phAddress:'Th√†nh ph·ªë, ƒë∆∞·ªùng, s·ªë nh√†‚Ä¶',phPhone:'+380 63 000 00 00',
          total:'T·ªïng c·ªông',checkout:'ƒê·∫∑t h√†ng',clear:'X√≥a gi·ªè h√†ng',
          errTable:'Vui l√≤ng nh·∫≠p s·ªë b√†n.',errPickup:'Vui l√≤ng nh·∫≠p th·ªùi gian nh·∫≠n (ph√∫t).',
          errPhone:'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.',errAddress:'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.'
        },
        common:{required:'(b·∫Øt bu·ªôc)',optional:'(kh√¥ng b·∫Øt bu·ªôc)'},
        tabbar:{menu:'Th·ª±c ƒë∆°n',lang:'Ng√¥n ng·ªØ',cart:'Gi·ªè',more:'Th√™m'}
      }
    };
    const L = () => I18N[LANG] || I18N.ru;
    /* Descriptions lazy-load */
    let DESCS = null;
    async function loadDescriptions(){
      if (DESCS) return DESCS;
      try{
        const resp = await fetch('descriptions.json');
        if (resp.ok){
          DESCS = await resp.json();
          return DESCS;
        }
      }catch(e){
        console.error('Failed to load descriptions.json', e);
      }
      DESCS = {};
      return DESCS;
    }
    /* Category labels ‚Äî UPDATED to match NEW menu.js keys */
    const CAT_LABELS = {
      pho_soups:{ru:'–§–æ (—Å—É–ø—ã)',ua:'–§–æ (—Å—É–ø–∏)',vn:'S√∫p Ph·ªü'},
      bun_soups:{ru:'–ë—É–Ω (—Å—É–ø—ã)',ua:'–ë—É–Ω (—Å—É–ø–∏)',vn:'S√∫p B√∫n'},
      salat_bun:{ru:'–ë—É–Ω (salat)',ua:'–ë—É–Ω (salat)',vn:'B√∫n nam bo'},
      mien_soups:{ru:'–ú–∏–µ–Ω (—Å—É–ø—ã)',ua:'–ú—ñ—î–Ω (—Å—É–ø–∏)',vn:'S√∫p Mi·∫øn'},
      mi_soups:{ru:'–ú–∏ (—Å—É–ø—ã)',ua:'–ú—ñ (—Å—É–ø–∏)',vn:'S√∫p M√¨'},
      wok_fried_pho:{ru:'–í–û–ö: –∂–∞—Ä–µ–Ω—ã–π –§–æ',ua:'–í–û–ö: —Å–º–∞–∂–µ–Ω–∏–π –§–æ',vn:'Wok Ph·ªü x√†o'},
      wok_fried_mien:{ru:'–í–û–ö: –∂–∞—Ä–µ–Ω—ã–π –ú–∏–µ–Ω',ua:'–í–û–ö: —Å–º–∞–∂–µ–Ω–∏–π –ú—ñ—î–Ω',vn:'Wok Mi·∫øn x√†o'},
      wok_fried_mi:{ru:'–í–û–ö: –∂–∞—Ä–µ–Ω–∞—è –ª–∞–ø—à–∞',ua:'–í–û–ö: —Å–º–∞–∂–µ–Ω–∞ –ª–æ–∫—à–∏–Ω–∞',vn:'Wok M√¨ x√†o'},
      rice_braised:{ru:'–†–∏—Å: —Ç—É—à—ë–Ω—ã–µ',ua:'–†–∏—Å: —Ç—É—à–∫–æ–≤–∞–Ω–µ',vn:'C∆°m kho'},
      fried_rice:{ru:'–†–∏—Å: –∂–∞—Ä–µ–Ω—ã–π',ua:'–°–º–∞–∂–µ–Ω–∏–π —Ä–∏—Å',vn:'C∆°m chi√™n'},
      appetizers:{ru:'–ó–∞–∫—É—Å–∫–∏',ua:'–ó–∞–∫—É—Å–∫–∏',vn:'M√≥n khai v·ªã'},
      drinks:{ru:'–ù–∞–ø–∏—Ç–∫–∏',ua:'–ù–∞–ø–æ—ó',vn:'ƒê·ªì u·ªëng'}
    };
    const catLabel = k => (CAT_LABELS[k]?.[LANG] || CAT_LABELS[k]?.ru || k);
    /* Helpers & state */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const CURRENCY = '–≥—Ä–Ω';
    const IMG_DIR = 'images/';
    const IMG_EXTS = ['webp','jpg','jpeg','png'];
    const fmt = n => Number(n).toFixed(2) + ' ' + CURRENCY;
    const escapeHtml = (s='') => String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
    function summarizeSelections(it, selections){
      const opts = normalizeOptions(it);
      const sel = selections || {};
      const parts = [];
      for (const g of opts){
        const gid = g.id || g.key || g.name || '';
        const picked = sel[gid];
        if (!picked) continue;
        const pickArr = Array.isArray(picked) ? picked : [picked];
        const names = pickArr.map(oid=>{
          const item = (g.items||[]).find(x => (x.id||x.key)===oid);
          const nm = item?.label?.[LANG] || item?.label?.ru || item?.label || item?.name || oid;
          const d = Number(item?.price_delta||0);
          return d ? `${nm} (+${d})` : `${nm}`;
        });
        const gTitle = g.title?.[LANG] || g.title?.ru || g.title || '';
        parts.push(gTitle ? `${gTitle}: ${names.join(', ')}` : names.join(', '));
      }
      return parts.join(' ¬∑ ');
    }
   
    function summarizeSelectionsLines(it, selections){
      const opts = normalizeOptions(it);
      const sel = selections || {};
      const lines = [];
      for (const g of opts){
        const gid = g.id || g.key || g.name || '';
        const picked = sel[gid];
        if (!picked) continue;
        const pickArr = Array.isArray(picked) ? picked : [picked];
        const names = pickArr.map(oid=>{
          const item = (g.items||[]).find(x => (x.id||x.key)===oid);
          return item?.label?.[LANG] || item?.label?.ru || item?.label || item?.name || oid;
        });
        const gTitle = groupTitle(g) || gid;
        lines.push(`${gTitle}: ${names.join(', ')}`);
      }
      return lines;
    }
function buildThumb(imgEl, key){
      let i = 0;
      const trySet = () => imgEl.src = IMG_DIR + key + '.' + IMG_EXTS[i];
      imgEl.onerror = () => {
        i++;
        if (i < IMG_EXTS.length){
          trySet();
        } else {
          imgEl.closest('.thumb')?.classList.add('noimg');
          imgEl.remove();
        }
      };
      trySet();
    }
    const itemName = it =>
      it?.translations?.[LANG] ||
      it?.translations?.ru ||
      it?.key?.replaceAll('_',' ') ||
      '';
    const CART_KEY = 'CD_CART_V2';
    const ORDERS_KEY = 'CD_ORDERS_V1';
    const SEARCH_KEY = 'CD_SEARCH_Q';
    const HERO_KEY = 'CD_HERO_CLOSED';
    // cart: Map(id -> {qty:number, selections:object, note:string})
    const cart = new Map();
    function loadCart(){
      try{
        const raw = localStorage.getItem(CART_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        for (const [id, entry] of Object.entries(obj || {})){
          if (!entry || typeof entry.qty !== 'number') continue;
          cart.set(id, {
            qty: Math.max(0, entry.qty|0),
            selections: entry.selections || {},
            note: entry.note || ''
          });
        }
      }catch(e){ console.warn('Cart load failed', e); }
    }
    function saveCart(){
      try{
        const obj = {};
        for (const [id, entry] of cart){
          obj[id] = entry;
        }
        localStorage.setItem(CART_KEY, JSON.stringify(obj));
      }catch(e){ console.warn('Cart save failed', e); }
    }
    function cartQty(id){ return cart.get(id)?.qty || 0; }
    function cartInc(id, delta=1){
      const cur = cart.get(id) || {qty:0, selections:{}, note:''};
      cur.qty = Math.max(0, (cur.qty|0) + delta);
      if (cur.qty<=0) cart.delete(id); else cart.set(id, cur);
      saveCart();
    }
    function cartSetEntry(id, entry){
      cart.set(id, entry);
      saveCart();
    }
    function loadOrders(){
      try{ return JSON.parse(localStorage.getItem(ORDERS_KEY) || '{}') || {}; }
      catch(e){ return {}; }
    }
    function saveOrders(obj){
      try{ localStorage.setItem(ORDERS_KEY, JSON.stringify(obj||{})); }catch(e){}
    }
    /* Pills */
    function renderPills(){
      const keys = Object.keys(menuData || {});
      const el = $('#catPills');
      if (!el) return;
      el.innerHTML = keys.map((k,i) =>
        `<a class="pill ${i===0?'active':''}" href="#sec-${k}">${catLabel(k)}</a>`
      ).join('');
    }
    /* View toggle (grid/list) */
    const VIEW_KEY = 'CD_VIEW_MENU';
    let viewMode = localStorage.getItem(VIEW_KEY) || 'grid';
    function applyView(){
      $$('.list').forEach(wrap => {
        wrap.classList.toggle('as-list', viewMode === 'list');
      });
    }
    /* Meta info */
    function buildMeta(it){
      if (!it) return '';
      const parts = [];
      if (it.weight) parts.push(it.weight + ' g');
      if (it.kcal) parts.push(it.kcal + ' kcal');
      if (it.spicy){
        const level = Math.max(1, Math.min(3, Number(it.spicy)));
        parts.push('üå∂'.repeat(level));
      }
      if (Array.isArray(it.tags) && it.tags.length){
        const mapped = it.tags.map(t=>{
          switch(t){
            case 'vegan': return 'üå± vegan';
            case 'veg': return 'ü•¶ veg';
            case 'no_gluten': return 'üö´ gluten';
            case 'chef': return '‚≠ê chef';
            case 'popular': return 'üî• top';
            default: return t;
          }
        });
        parts.push(mapped.join(' ¬∑ '));
      }
      if (!parts.length) return '';
      return `<div class="meta">${parts.join(' ‚Ä¢ ')}</div>`;
    }
    /* Options / pricing */
    function normalizeOptions(it){
      return Array.isArray(it?.options) ? it.options : [];
    }
    function calcItemUnitPrice(it, selections){
      let base = Number(it?.price || 0);
      const opts = normalizeOptions(it);
      const sel = selections || {};
      for (const g of opts){
        const gid = g.id || g.key || g.name || '';
        const picked = sel[gid];
        if (!picked) continue;
        const pickArr = Array.isArray(picked) ? picked : [picked];
        for (const oid of pickArr){
          const found = (g.items || []).find(x => (x.id||x.key) === oid);
          if (found) base += Number(found.price_delta || 0);
        }
      }
      return base;
    }
    /* Render menu */
    const TOP_KEYS = ['pho_bo_xao','mi_xao_tom','mien_xao_heo','com_rang_ga','salat_bun_nem'];
    function findByKey(key){
      for (const [cat, arr] of Object.entries(menuData||{})){
        const idx = (arr||[]).findIndex(x => x && x.key === key);
        if (idx >= 0) return {cat, idx, it: arr[idx]};
      }
      return null;
    }
    function cardHtml(it, id, featured=false){
      const t = L();
      const name = itemName(it);
      const unit = fmt(calcItemUnitPrice(it, cart.get(id)?.selections));
      const qty = cartQty(id);
      const hasOpts = Array.isArray(it.options) && it.options.length;
      const btn = qty
        ? `<div class="qty" data-qty="${id}">
             <button data-dec="${id}">‚àí</button>
             <span>${qty}</span>
             <button data-inc="${id}">+</button>
           </div>`
        : `<button class="add" data-add="${id}">${t.ui.add}</button>`;
      const key = (it && (it.key || it.id || it.code)) || '';
      const shortDesc = (it && (it.short || it.desc || '')) || '';
      const metaHtml = buildMeta(it);
      return `
        <div class="card ${featured?'featured':''} ${hasOpts?'has-opts':''}" data-id="${id}"${key ? ` data-key="${key}"` : ''}>
          <div class="thumb-wrap">
            <div class="thumb">
              <img alt="${escapeHtml(name)}" loading="lazy" decoding="async">
            </div>
            <button class="info"
                    data-toggle="${id}"
                    title="‚Ñπ"
                    aria-label="Info"
                    aria-expanded="false">‚Ñπ</button>
          </div>
          <div class="name">${escapeHtml(name)}</div>
          ${metaHtml}
          <p class="desc">${escapeHtml(shortDesc)}</p>
          <div class="foot">
            <div class="price">${unit}</div>
            ${btn}
          </div>
        </div>`;
    }
    function renderSection(content, title, items){
      const sec = document.createElement('section');
      sec.className = 'menu-section';
      sec.id = title.startsWith('TOP') ? 'sec-top' : '';
      const h2 = document.createElement('h2');
      h2.textContent = title;
      sec.appendChild(h2);
      const list = document.createElement('div');
      list.className = 'list';
      list.innerHTML = items.join('');
      sec.appendChild(list);
      content.appendChild(sec);
      // images
      list.querySelectorAll('.card').forEach(row => {
        const id = row.getAttribute('data-id');
        const [cat, idx] = id.split(':');
        const key = (menuData?.[cat]?.[+idx]?.key) || '';
        const img = row.querySelector('.thumb img');
        if (img && key) buildThumb(img, key);
      });
    }
    function renderMenu(){
      const content = $('#content');
      if (!content) return;
      content.innerHTML = '';
      const q = (document.getElementById('searchIn')?.value || '').trim().toLowerCase();
      localStorage.setItem(SEARCH_KEY, q);
      // Search results mode
      if (q){
        const res = [];
        for (const [cat, arr] of Object.entries(menuData || {})){
          (arr||[]).forEach((it, idx)=>{
            const name = itemName(it).toLowerCase();
            const short = String(it.short||'').toLowerCase();
            if (name.includes(q) || short.includes(q)){
              const id = `${cat}:${idx}`;
              res.push(cardHtml(it, id, false));
            }
          });
        }
        renderSection(content, `üîé ${q}`, res.length ? res : [`<div class="muted" style="padding:12px">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`]);
        applyView();
        return;
      }
      // TOP section
      const topCards = [];
      TOP_KEYS.forEach((k, i)=>{
        const f = findByKey(k);
        if (!f) return;
        const id = `${f.cat}:${f.idx}`;
        topCards.push(cardHtml(f.it, id, i===0));
      });
      if (topCards.length){
        renderSection(content, 'üî• TOP', topCards);
      }
      // Normal categories
      const keys = Object.keys(menuData || {});
      keys.forEach(k => {
        const items = (menuData[k] || []).map((it, idx) => {
          const id = `${k}:${idx}`;
          return cardHtml(it, id, idx===0);
        });
        renderSection(content, catLabel(k), items);
        // ensure section id for scroll
        const last = content.lastElementChild;
        if (last) last.id = `sec-${k}`;
      });
      applyView();
    }
    /* Cart counters + dock badges */
    function renderFab(){
      let items = 0, sum = 0;
      for (const [id, entry] of cart){
        const qty = entry?.qty || 0;
        const [cat, idx] = id.split(':');
        const it = menuData[cat]?.[+idx];
        if (!it || qty<=0) continue;
        items += qty;
        sum += calcItemUnitPrice(it, entry.selections) * qty;
      }
      const badge = $('#cartBadge');
      document.body.classList.toggle('cart-has-items', items > 0);
      if (badge){
        badge.textContent = items;
        badge.style.display = items > 0 ? 'flex' : 'none';
      }
      const meta = $('#cartMeta');
      if (meta){
        const s = L().sheet;
        meta.textContent = `${s.total}: ${fmt(sum)}`;
      }
    }
    /* Cart sheet render */
    function renderCartSheet(){
      const t = L().sheet;
      const lines = $('#cartLines');
      if (!lines) return;
      if (cart.size === 0){
        lines.innerHTML = `<div class="muted">${t.empty}</div>`;
        $('#cartMeta').textContent = `${t.total}: ${fmt(0)}`;
        return;
      }
      let sum = 0;
      lines.innerHTML = '';
      for (const [id, entry] of cart){
        const qty = entry?.qty || 0;
        if (qty<=0) continue;
        const [cat, idx] = id.split(':');
        const it = menuData[cat]?.[+idx];
        if (!it) continue;
        const name = itemName(it);
        const unit = calcItemUnitPrice(it, entry.selections);
        sum += unit * qty;
        const optText = summarizeSelections(it, entry.selections);
        const noteText = (entry.note || '').trim();
        const el = document.createElement('div');
        el.className = 'line';
        el.innerHTML = `
          <div>
            <strong>${name}</strong>
            ${optText ? `<div class="muted">${optText}</div>` : ``}
            ${noteText ? `<div class="muted">‚úé ${escapeHtml(noteText)}</div>` : ``}
            <div class="muted">${fmt(unit)} √ó ${qty}</div>
          </div>
          <div class="qty" data-qty="${id}">
            <button data-dec="${id}">‚àí</button>
            <span>${qty}</span>
            <button data-inc="${id}">+</button>
          </div>`;
        lines.appendChild(el);
      }
      $('#cartMeta').textContent = `${t.total}: ${fmt(sum)}`;
    }
    /* Sheet open/close */
    function openSheet(){
      document.body.style.overflow = 'hidden';
      document.body.classList.add('sheet-open');
      $('#overlay').classList.add('show');
      $('#sheet').classList.add('open');
      renderCartSheet();
    }
    function closeSheet(){
      document.body.style.overflow = '';
      document.body.classList.remove('sheet-open');
      const overlay = document.getElementById('overlay');
      const sheet = document.getElementById('sheet');
      if (overlay){
        overlay.classList.remove('show');
        overlay.style.opacity = '';
        overlay.style.transition = '';
      }
      if (sheet){
        sheet.classList.remove('open');
        sheet.style.transform = '';
        sheet.style.transition = '';
      }
    }
    function openCatSheet(){
      document.body.classList.add('sheet-open');
      $('#catOverlay').classList.add('show');
      $('#catSheet').classList.add('open');
    }
    function closeCatSheet(){
      document.body.classList.remove('sheet-open');
      const overlay = document.getElementById('catOverlay');
      const sheet = document.getElementById('catSheet');
      if (overlay){
        overlay.classList.remove('show');
        overlay.style.opacity = '';
        overlay.style.transition = '';
      }
      if (sheet){
        sheet.classList.remove('open');
        sheet.style.transform = '';
        sheet.style.transition = '';
      }
    }
    /* Dish sheet open/close + rendering */
    const dishOverlay = $('#dishOverlay');
    const dishSheet = $('#dishSheet');
    const dishClose = $('#dishClose');
    const dishTitle = $('#dishTitle');
    const dishSub = $('#dishSub');
    const dishPriceEl = $('#dishPrice');
    const dishMedia = $('#dishMedia');
    const dishDesc = $('#dishDesc');
    const dishOptions = $('#dishOptions');
    const dishNote = $('#dishNote');
    const dishMinus = $('#dishMinus');
    const dishPlus = $('#dishPlus');
    const dishQtyEl = $('#dishQty');
    const dishAddBtn = $('#dishAddBtn');
    let dishCtx = null; // {id, cat, idx, it, tempSel, tempNote}
    function openDishSheet(){
      document.body.classList.add('sheet-open');
      dishOverlay?.classList.add('show');
      dishSheet?.classList.add('open');
    }
    function closeDishSheet(){
      document.body.classList.remove('sheet-open');
      dishOverlay?.classList.remove('show');
      dishSheet?.classList.remove('open');
      dishCtx = null;
    }
    function isRequiredGroup(g){
      return !!g.required;
    }
    function groupTitle(g){
      return g.title?.[LANG] || g.title?.ru || g.title || '';
    }
    function optionLabel(o){
      return o.label?.[LANG] || o.label?.ru || o.label || o.name || o.id || '';
    }
    function validateSelections(it, selections){
      // User requested: allow adding even if required groups are not selected.
      // We only enforce max limits to avoid impossible states.
      const opts = normalizeOptions(it);
      for (const g of opts){
        const gid = g.id || g.key || g.name || '';
        const picked = selections?.[gid];
        if (g.max && Array.isArray(picked) && picked.length > Number(g.max)){
          return {ok:false, groupId: gid, title: groupTitle(g) || gid};
        }
      }
      return {ok:true};
    }
    function renderDishOptions(it, selections){
      const opts = normalizeOptions(it);
      if (!dishOptions) return;
      if (!opts.length){
        dishOptions.innerHTML = '';
        return;
      }
      dishOptions.innerHTML = opts.map(g=>{
        const gid = g.id || g.key || g.name || '';
        const multi = !!g.multi || (Number(g.max || 0) > 1);
        const max = Number(g.max || (multi ? 99 : 1));
        const required = !!g.required;
        const picked = selections?.[gid] || (multi ? [] : '');
        const pickedArr = Array.isArray(picked) ? picked : [picked].filter(Boolean);
        const itemsHtml = (g.items||[]).map(opt=>{
          const oid = opt.id || opt.key;
          const checked = pickedArr.includes(oid);
          const delta = Number(opt.price_delta || 0);
          const deltaHtml = delta ? `<span class="delta">${delta>0?`+${delta}`:delta} ${CURRENCY}</span>` : '';
          return `
            <label class="opt">
              <input type="${multi?'checkbox':'radio'}"
                     name="opt-${gid}"
                     value="${escapeHtml(oid)}"
                     ${checked?'checked':''}
                     data-gid="${escapeHtml(gid)}"
                     data-multi="${multi?'1':'0'}"
                     data-max="${max}">
              <span class="opt-name">${escapeHtml(optionLabel(opt))}</span>
              ${deltaHtml}
            </label>
          `;
        }).join('');
        return `
          <div class="opt-group" data-group="${escapeHtml(gid)}">
            <div class="opt-head">
              <div class="opt-title">${escapeHtml(groupTitle(g) || '')}</div>
              <div class="muted opt-hint">${required ? L().common.required : L().common.optional}${max && max<99 ? ` ¬∑ max ${max}`:''}</div>
            </div>
            <div class="opt-list">${itemsHtml}</div>
          </div>
        `;
      }).join('');
    }
    async function renderDishSheet(ctx){
      const {id, it} = ctx;
      dishTitle.textContent = itemName(it);
      dishSub.textContent = buildMeta(it).replace(/<[^>]*>/g,'') || '';
      dishQtyEl.textContent = String(cartQty(id));
      // image
      dishMedia.innerHTML = '';
      const key = it.key || '';
      if (key){
        const wrap = document.createElement('div');
        wrap.className = 'dish-thumb';
        wrap.innerHTML = `<img alt="${escapeHtml(itemName(it))}" loading="lazy" decoding="async">`;
        const img = wrap.querySelector('img');
        dishMedia.appendChild(wrap);
        if (img) buildThumb(img, key);
      }
      // desc lazy
      dishDesc.textContent = it.short || it.desc || '';
      try{
        const descs = await loadDescriptions();
        const entry = key ? descs[key] : null;
        const text = entry?.description?.[LANG] || entry?.description?.ru || '';
        if (text) dishDesc.textContent = text;
      }catch(e){}
      // options
      renderDishOptions(it, ctx.tempSel);
      // note
      dishNote.value = ctx.tempNote || '';
      // price
      updateDishPrice();
    }
    function updateDishPrice(){
      if (!dishCtx) return;
      const it = dishCtx.it;
      const unit = calcItemUnitPrice(it, dishCtx.tempSel);
      dishPriceEl.textContent = fmt(unit);
    }
    function openDishById(cardId){
      const [cat, idxStr] = (cardId||'').split(':');
      const idx = Number(idxStr);
      const it = menuData?.[cat]?.[idx];
      if (!it) return;
      const entry = cart.get(cardId) || {qty:0, selections:{}, note:''};
      dishCtx = {
        id: cardId,
        cat, idx,
        it,
        tempSel: JSON.parse(JSON.stringify(entry.selections||{})),
        tempNote: entry.note || ''
      };
      openDishSheet();
      renderDishSheet(dishCtx);
    }
    dishOverlay?.addEventListener('click', closeDishSheet);
    dishClose?.addEventListener('click', (e)=>{ e.stopPropagation(); closeDishSheet(); });
    dishOptions?.addEventListener('change', (e)=>{
      if (!dishCtx) return;
      const inp = e.target.closest('input[data-gid]');
      if (!inp) return;
      const gid = inp.dataset.gid;
      const multi = inp.dataset.multi === '1';
      const max = Number(inp.dataset.max || 99);
      if (multi){
        const arr = Array.isArray(dishCtx.tempSel[gid]) ? dishCtx.tempSel[gid] : [];
        if (inp.checked){
          if (arr.length >= max){
            inp.checked = false;
            return;
          }
          arr.push(inp.value);
        } else {
          const i = arr.indexOf(inp.value);
          if (i>=0) arr.splice(i,1);
        }
        dishCtx.tempSel[gid] = arr;
      } else {
        dishCtx.tempSel[gid] = inp.value;
      }
      updateDishPrice();
    });
    dishNote?.addEventListener('input', ()=>{
      if (!dishCtx) return;
      dishCtx.tempNote = dishNote.value;
    });
    dishMinus?.addEventListener('click', ()=>{
      if (!dishCtx) return;
      cartInc(dishCtx.id, -1);
      dishQtyEl.textContent = String(cartQty(dishCtx.id));
      renderMenu(); renderCartSheet(); renderFab();
    });
    dishPlus?.addEventListener('click', ()=>{
      if (!dishCtx) return;
      // If qty becomes 1 from 0, store selections+note
      const current = cart.get(dishCtx.id);
      if (!current || current.qty<=0){
        cartSetEntry(dishCtx.id, {qty:1, selections:dishCtx.tempSel||{}, note:(dishCtx.tempNote||'')});
      } else {
        cartInc(dishCtx.id, +1);
      }
      dishQtyEl.textContent = String(cartQty(dishCtx.id));
      renderMenu(); renderCartSheet(); renderFab();
    });
    dishAddBtn?.addEventListener('click', ()=>{
      if (!dishCtx) return;
      const v = validateSelections(dishCtx.it, dishCtx.tempSel);
      if (!v.ok){
        alert(`–í—ã–±–µ—Ä–∏—Ç–µ: ${v.title}`);
        const gEl = dishOptions?.querySelector(`.opt-group[data-group="${CSS.escape(v.groupId)}"]`);
        gEl?.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      const q = cartQty(dishCtx.id);
      if (q<=0){
        cartSetEntry(dishCtx.id, {qty:1, selections:dishCtx.tempSel||{}, note:(dishCtx.tempNote||'')});
      } else {
        const entry = cart.get(dishCtx.id) || {qty:q, selections:{}, note:''};
        entry.selections = dishCtx.tempSel||{};
        entry.note = dishCtx.tempNote||'';
        cartSetEntry(dishCtx.id, entry);
      }
      dishQtyEl.textContent = String(cartQty(dishCtx.id));
      renderMenu(); renderCartSheet(); renderFab();
      closeDishSheet();
      openSheet();
    });
        /* Global click handlers */
    document.addEventListener('click', async e=>{
      const add = e.target.closest('[data-add]');
      if (add){
        const id = add.dataset.add;
        const [cat, idx] = id.split(':');
        const it = menuData?.[cat]?.[+idx];
        // If dish has options / constructor ‚Äî open modal
        if (it && (Array.isArray(it.options) && it.options.length)){
          openDishById(id);
          return;
        }
        cartInc(id, +1);
        renderMenu(); renderFab();
        return;
      }
      const inc = e.target.closest('[data-inc]');
      if (inc){
        const id = inc.dataset.inc;
        cartInc(id, +1);
        renderMenu(); renderCartSheet(); renderFab();
        return;
      }
      const dec = e.target.closest('[data-dec]');
      if (dec){
        const id = dec.dataset.dec;
        cartInc(id, -1);
        renderMenu(); renderCartSheet(); renderFab();
        return;
      }
      const info = e.target.closest('[data-toggle]');
      if (info){
        e.preventDefault();
        const cardId = info.dataset.toggle;
        openDishById(cardId);
        return;
      }
      const cardTap = e.target.closest('.card[data-id]');
      if (cardTap && !e.target.closest('.add') && !e.target.closest('.qty') && !e.target.closest('.info')){
        const cid = cardTap.getAttribute('data-id');
        openDishById(cid);
        return;
      }
      if (e.target.id === 'overlay'){ closeSheet(); return; }
      if (e.target.id === 'clearBtn'){
        cart.clear(); saveCart();
        renderMenu(); renderCartSheet(); renderFab();
        return;
      }
    });
    /* Burger menu */
    const burgerBtn = $('#burgerBtn');
    const navPop = $('#navPop');
    burgerBtn.addEventListener('click', ()=>{
      const open = navPop.classList.toggle('open');
      burgerBtn.setAttribute('aria-expanded', String(open));
    });
    document.addEventListener('click', e=>{
      const navPop = document.getElementById('navPop');
      const burgerBtn= document.getElementById('burgerBtn');
      const dockMore = document.getElementById('dockMore');
      if (!navPop) return;
      if (!navPop.contains(e.target) && e.target !== burgerBtn && e.target !== dockMore) {
        navPop.classList.remove('open');
        burgerBtn?.setAttribute('aria-expanded','false');
      }
    });
    /* Order type switch */
    const otWrap = $('#orderType');
    const tableField = $('#tableField');
    const takeawayField = $('#takeawayField');
    const addrField = $('#addrField');
    const tableNo = $('#tableNo');
    const pickupIn = $('#pickupIn');
    const address = $('#address');
    const phone = $('#phone');
    const phoneHint = $('#phoneHint');
    const tableHint = $('#tableHint');
    const pickupHint = $('#pickupHint');
    const addrHint = $('#addrHint');
    function show(el,on){ if(el) el.style.display = on?'grid':'none'; }
    function setOrderType(v){
      const c = L();
      show(tableField, v === 'on_site');
      show(takeawayField, v === 'takeaway');
      show(addrField, v === 'delivery');
      if (tableNo) tableNo.required = (v === 'on_site');
      if (pickupIn) pickupIn.required = (v === 'takeaway');
      if (address) address.required = (v === 'delivery');
      phoneHint.textContent = (v === 'on_site') ? c.common.optional : c.common.required;
      tableHint.textContent = c.common.required;
      pickupHint.textContent = c.common.required;
      addrHint.textContent = c.common.required;
    }
    otWrap.addEventListener('click', e=>{
      const b = e.target.closest('[data-ot]');
      if (!b) return;
      $$('#orderType .chip').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      setOrderType(b.dataset.ot);
    });
    /* Dock labels */
    function applyDockLabels(){
      const t = L();
      const tb = t.tabbar || {};
      const sheetT = t.sheet;
      const dm = $('#dockCat');
      const dl = $('#dockLang');
      const dc = $('#dockCart');
      const dv = $('#dockView');
      const dr = $('#dockMore');
      if (dm) dm.dataset.label = tb.menu || t.navMenu || 'Menu';
      if (dl) dl.dataset.label = tb.lang || 'Lang';
      if (dc) dc.dataset.label = tb.cart || (sheetT && sheetT.title) || 'Cart';
      if (dv) dv.dataset.label = (viewMode === 'grid' ? t.ui.viewGrid : t.ui.viewList);
      if (dr) dr.dataset.label = tb.more || 'More';
    }
    /* I18N apply */
    const selA = $('#langSel');
    const selB = $('#langSelMenu');
    function setUITexts(){
      const t = L();
      const s = t.sheet;
      $('#navHome').textContent = 'üè† ' + t.navHome;
      $('#navMenu').textContent = 'üçú ' + t.navMenu;
      $('#navKaraoke').textContent = 'üé§ ' + t.navKaraoke;
      $('#navContact').textContent = 'üìû ' + t.navContact;
      $('#sheetTitle').textContent = s.title;
      $('#orderTypeTitle').textContent = s.orderType;
      $('#otOnSite').textContent = s.onSite;
      $('#otTakeaway').textContent = s.takeaway;
      $('#otDelivery').textContent = s.delivery;
      $('#tableLbl').childNodes[0].nodeValue = s.table + ' ';
      $('#pickupLbl').childNodes[0].nodeValue = s.pickupIn + ' ';
      $('#addrLbl').childNodes[0].nodeValue = s.address + ' ';
      $('#phoneLbl').childNodes[0].nodeValue = s.phone + ' ';
      tableNo.placeholder = s.phTable;
      pickupIn.placeholder = s.phPickup;
      address.placeholder = s.phAddress;
      phone.placeholder = s.phPhone;
      $('#checkoutBtn').textContent = s.checkout;
      $('#clearBtn').textContent = s.clear;
      const csTitle = $('#catSheetTitle');
      if (csTitle) csTitle.textContent = t.navMenu || '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';
      renderPills();
      renderMenu();
      renderFab();
      renderCartSheet();
      const active = document.querySelector('#orderType .chip.active')?.dataset.ot || 'on_site';
      setOrderType(active);
      applyDockLabels();
    }
    /* Search + order status UI */
    const searchInEl = $('#searchIn');
    const searchClearEl = $('#searchClear');
    const statusCodeEl = $('#statusCode');
    const statusBtnEl = $('#statusBtn');
    const statusResultEl = $('#statusResult');
    const debouncedRenderMenu = (()=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(()=>{ renderMenu(); renderFab(); }, 120); }; })();
    function renderStatus(code){
      const orders = loadOrders();
      const rec = orders[(code||'').trim().toLowerCase()];
      if (!statusResultEl) return;
      if (!code){
        statusResultEl.innerHTML = '';
        return;
      }
      if (!rec){
        statusResultEl.innerHTML = `<div class="muted">–ó–∞–∫–∞–∑ <b>${escapeHtml(code)}</b> –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>`;
        return;
      }
      const when = new Date(rec.created_at).toLocaleString();
      const total = Number(rec.total||0).toFixed(2);
      statusResultEl.innerHTML = `
        <div class="status-card">
          <div><b>–ö–æ–¥:</b> ${escapeHtml(rec.code)} <span class="pill-mini">${escapeHtml(rec.status||'‚Äî')}</span></div>
          <div class="muted">ID: ${escapeHtml(rec.id)} ¬∑ ${escapeHtml(when)}</div>
          <div class="muted">–ò—Ç–æ–≥–æ: ${total} ${escapeHtml(rec.currency||CURRENCY)}</div>
        </div>
      `;
    }
    searchInEl?.addEventListener('input', debouncedRenderMenu);
    searchClearEl?.addEventListener('click', ()=>{
      if (!searchInEl) return;
      searchInEl.value = '';
      debouncedRenderMenu();
      searchInEl.focus();
    });
    statusBtnEl?.addEventListener('click', ()=>{
      const code = statusCodeEl?.value || '';
      renderStatus(code);
    });
    statusCodeEl?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        renderStatus(statusCodeEl.value);
      }
    });
    function setLang(v){
      LANG = v;
      localStorage.setItem(LANG_KEY, v);
      document.documentElement.lang = v;
      if (selA) selA.value = v;
      if (selB) selB.value = v;
      const flag = LANG_FLAGS[v] || 'üåê';
      const langFlagEl = $('#dockLangFlag');
      if (langFlagEl) langFlagEl.textContent = flag;
      const savedQ = localStorage.getItem(SEARCH_KEY) || '';
      const searchIn = document.getElementById('searchIn');
      if (searchIn) searchIn.value = savedQ;
      setUITexts();
      document.dispatchEvent(new CustomEvent('CD_LANG_CHANGED'));
    }
    selA?.addEventListener('change', e => setLang(e.target.value));
    selB?.addEventListener('change', e => setLang(e.target.value));
    /* Telegram via proxy */
    /* Telegram: direct or proxy (recommended proxy, but you want token in index) */
    const TG = {
      BOT_TOKEN: "6819820426:AAEWwwN8tYLVPo6U-g6EjWCo4evnJ2SaGk4", // <-- —Ç–≤–æ–π —Ç–æ–∫–µ–Ω
      CHAT_ID: "-1002283682762", // <-- —Ç–≤–æ–π chat id
      PROXY_URL: "" // "/api/tg/sendMessage" –µ—Å–ª–∏ –±—É–¥–µ—Ç —Å–µ—Ä–≤–µ—Ä
    };
    function TG_ENDPOINT() {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ ‚Äî —à–ª—ë–º —Ç—É–¥–∞ (—Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–∞)
      if (TG.PROXY_URL && TG.PROXY_URL.trim()) return TG.PROXY_URL;
      // –ò–Ω–∞—á–µ –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram
      if (!TG.BOT_TOKEN) throw new Error("TG.BOT_TOKEN is empty");
      return `https://api.telegram.org/bot${TG.BOT_TOKEN}/sendMessage`;
    }
    async function sendOrderToTelegram(text) {
      const url = TG_ENDPOINT();
      const payload = {
        chat_id: TG.CHAT_ID,
        text,
        parse_mode: "HTML",
        disable_web_page_preview: true
      };
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      // –ï—Å–ª–∏ —à–ª—ë–º –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram ‚Äî –æ–Ω –≤–µ—Ä–Ω—ë—Ç JSON —Å ok:true/false
      // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ —Ç–≤–æ–π –ø—Ä–æ–∫—Å–∏ ‚Äî —Ç–æ–∂–µ —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª JSON {ok:true} / {ok:false, error:"..."}
      let data = null;
      try { data = await r.json(); } catch (_) {}
      if (!r.ok) {
        const msg = (data && (data.description || data.error)) || `HTTP ${r.status}`;
        return { ok: false, reason: msg };
      }
      if (data && data.ok === false) {
        return { ok: false, reason: data.description || "Telegram error" };
      }
      return { ok: true, data };
    }
    async function createOrderOnSheet(orderPayload){
      const body = { action:'create', ...orderPayload };
      try{
        const res = await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        const data = await res.json();
        return data;
      }catch(e){
        console.error('Sheets error', e);
        return {ok:false, error:String(e)};
      }
    }
    function cartSummary(){
      let itemsCount = 0, sum = 0;
      const lines = [];
      const items = [];
      for (const [id, entry] of cart){
        const qty = entry?.qty || 0;
        if (qty<=0) continue;
        const [cat, idx] = id.split(':');
        const it = menuData[cat]?.[+idx];
        if (!it) continue;
        const name = itemName(it);
        const unit = calcItemUnitPrice(it, entry.selections);
        const key = it.key || it.id || it.code || '';
        const optText = summarizeSelections(it, entry.selections);
        const noteText = (entry.note || '').trim();
        itemsCount += qty;
        sum += unit * qty;
        const extra = [optText ? `(${optText})` : '', noteText ? `[${noteText}]` : ''].filter(Boolean).join(' ');
        const isCustom = (Array.isArray(it.tags) && it.tags.includes('custom')) || String(it.key||'').startsWith('custom_');
        if (isCustom){
          const optLines = summarizeSelectionsLines(it, entry.selections);
          lines.push(`‚Ä¢ ${name} ‚Äî ${unit.toFixed(2)} ${CURRENCY} √ó ${qty}`);
          for (const l of optLines){ lines.push(` ‚îî ${l}`); }
          if (noteText) lines.push(` ‚îî Note: ${noteText}`);
        } else {
          lines.push(`‚Ä¢ ${name} ${extra} ‚Äî ${unit.toFixed(2)} ${CURRENCY} √ó ${qty}`);
        }
        items.push({ name, price: unit, qty, key, selections: entry.selections || {}, note: noteText });
      }
      return {itemsCount,sum,lines,items};
    }
    function generateShortCode(){
      const letters = 'abcdefghijklmnopqrstuvwxyz';
      const letter = letters[Math.floor(Math.random() * letters.length)];
      const num = Math.floor(Math.random() * 999) + 1;
      return letter + String(num).padStart(3,'0');
    }
    $('#checkoutBtn').addEventListener('click', async ()=>{
      const s = L().sheet;
      const ot = document.querySelector('#orderType .chip.active')?.dataset.ot || 'on_site';
      if (ot === 'on_site' && !tableNo.value.trim()){ alert(s.errTable); return; }
      if (ot === 'takeaway'){
        if (!pickupIn.value.trim()){ alert(s.errPickup); return; }
        if (!phone.value.trim()){ alert(s.errPhone); return; }
      }
      if (ot === 'delivery'){
        if (!address.value.trim()){ alert(s.errAddress); return; }
        if (!phone.value.trim()){ alert(s.errPhone); return; }
      }
      const {sum,lines,items} = cartSummary();
      const typeStr = ot === 'on_site' ? s.onSite : ot === 'takeaway' ? s.takeaway : s.delivery;
      const meta = [];
      if (ot === 'on_site') meta.push(`${s.table}: ${tableNo.value.trim()}`);
      if (ot === 'takeaway') meta.push(`${s.pickupIn}: ${pickupIn.value.trim()}`);
      if (ot === 'delivery') meta.push(`${s.address}: ${address.value.trim()}`);
      if (phone.value.trim()) meta.push(`${s.phone}: ${phone.value.trim()}`);
      const ordId = 'CD-'+new Date().toISOString().replace(/[-:TZ.]/g,'').slice(0,14);
      const orderCode = generateShortCode();
      const text =
`<b>CYBER DRAGON dlv‚Äî New order</b>
ID: <code>${ordId}</code>
Code: <b>${orderCode}</b>
${s.total}: <b>${sum.toFixed(2)} ${CURRENCY}</b>
Type: <b>${typeStr}</b>
${meta.join('\n')}
<b>Items:</b>
${lines.join('\n') || '‚Äî'}`;
      const orderPayload = {
        id: ordId,
        code: orderCode,
        status: 'NEW',
        type: ot,
        table: ot==='on_site' ? tableNo.value.trim() : '',
        pickup_in: ot==='takeaway' ? pickupIn.value.trim() : '',
        address: ot==='delivery' ? address.value.trim() : '',
        phone: phone.value.trim(),
        items,
        total: sum,
        created_at: new Date().toISOString()
      };
      const [tgRes, sheetRes] = await Promise.all([
        sendOrderToTelegram(text),
        createOrderOnSheet(orderPayload)
      ]);
      // Save local status (client-side only)
      const orders = loadOrders();
      orders[orderCode] = {
        code: orderCode,
        id: ordId,
        created_at: orderPayload.created_at,
        total: sum,
        currency: CURRENCY,
        type: ot,
        meta,
        items,
        tg: tgRes,
        sheet: sheetRes,
        status: (tgRes?.ok ? (tgRes?.opaque ? 'SENT (unconfirmed)' : 'SENT') : 'FAILED')
      };
      saveOrders(orders);
      let icon;
      if ((tgRes?.ok) && (sheetRes?.ok || sheetRes?.id)) icon = '‚úî‚úî';
      else if (tgRes?.ok || sheetRes?.ok || sheetRes?.id) icon = '‚úî‚Ä¶';
      else icon = '‚Ä¶';
      alert(`${icon} ID: ${ordId} ‚Ä¢ ${s.total}: ${sum.toFixed(2)} ${CURRENCY}`);
      cart.clear(); saveCart();
      renderMenu();
      renderCartSheet();
      renderFab();
      closeSheet();
    });
    /* Scroll highlight for pills */
    let activeCat = '';
    const debounce = (fn,delay) => { let timer; return () => { clearTimeout(timer); timer = setTimeout(fn,delay); }; };
    function updateActive(){
      const header = $('.header');
      const catNav = $('.cat-nav');
      if (!header || !catNav) return;
      const stickyH = header.offsetHeight + catNav.offsetHeight;
      let maxTop = -Infinity;
      let closest = null;
      $$('section').forEach(sec => {
        if (!sec.id || !sec.id.startsWith('sec-')) return;
        const top = sec.getBoundingClientRect().top;
        if (top <= stickyH && top > maxTop){
          maxTop = top;
          closest = sec;
        }
      });
      if (closest){
        const cat = closest.id.replace('sec-','');
        if (cat !== activeCat){
          activeCat = cat;
          $$('.pill').forEach(p => p.classList.remove('active'));
          const pill = $(`.pill[href="#${closest.id}"]`);
          if (pill){
            pill.classList.add('active');
            pill.scrollIntoView({behavior:'smooth',inline:'center'});
          }
        }
      }
    }
    window.addEventListener('scroll', debounce(updateActive,50));
    /* Dynamic Island + move pills into bar */
    const catPillsEl = $('#catPills');
    const catPillsParent = catPillsEl?.parentNode || null;
    const catPillsSibling = catPillsEl?.nextSibling || null;
    function islandThreshold(){ return 80; }
    let islandActive = false;
    const onScrollIsland = (() => {
      let ticking = false;
      return () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          const needIsland = window.scrollY > islandThreshold();
          if (needIsland !== islandActive){
            islandActive = needIsland;
            document.body.classList.toggle('island', islandActive);
            const bar = $('.bar');
            const catPills = $('#catPills');
            if (islandActive){
              if (bar && catPills) bar.appendChild(catPills);
            } else {
              if (catPillsParent && catPills){
                if (catPillsSibling) catPillsParent.insertBefore(catPills,catPillsSibling);
                else catPillsParent.appendChild(catPills);
              }
            }
          }
          ticking = false;
        });
      };
    })();
    window.addEventListener('scroll', onScrollIsland, {passive:true});
    window.addEventListener('resize', onScrollIsland);
    onScrollIsland();
    /* ===== Bottom Dock logic ===== */
    const dockCat = $('#dockCat');
    const dockView = $('#dockView');
    const dockMore = $('#dockMore');
    const dockLang = $('#dockLang');
    const dockCart = $('#dockCart');
    const langPopup = $('#langPopup');
    const catOverlayEl = $('#catOverlay');
    const catSheetEl = $('#catSheet');
    const catSheetList = $('#catSheetList');
    function buildCatSheet(){
      if (!catSheetList) return;
      const keys = Object.keys(menuData || {});
      catSheetList.innerHTML = keys.map(k =>
        `<button class="chip" data-goto="#sec-${k}">${catLabel(k)}</button>`
      ).join('');
    }
    catOverlayEl?.addEventListener('click', closeCatSheet);
    catSheetEl?.addEventListener('click', e=>{
      const b = e.target.closest('[data-goto]');
      if (!b) return;
      const target = b.getAttribute('data-goto');
      closeCatSheet();
      document.querySelector(target)?.scrollIntoView({behavior:'smooth',block:'start'});
    });
    function setActiveDock(btn){
      $$('.dock-btn').forEach(b=>{
        if (b === btn) b.classList.add('active');
        else b.classList.remove('active');
      });
    }
    dockCat?.addEventListener('click', ()=>{
      setActiveDock(dockCat);
      buildCatSheet();
      openCatSheet();
    });
    dockView?.addEventListener('click', ()=>{
      setActiveDock(dockView);
      viewMode = (viewMode === 'grid') ? 'list' : 'grid';
      localStorage.setItem(VIEW_KEY, viewMode);
      applyView();
      applyDockLabels();
    });
    dockLang?.addEventListener('click', (e)=>{
      e.stopPropagation();
      setActiveDock(dockLang);
      if (!langPopup) return;
      langPopup.classList.toggle('show');
    });
    langPopup?.addEventListener('click', e=>{
      const b = e.target.closest('[data-lang]');
      if (!b) return;
      const code = b.dataset.lang;
      setLang(code);
      langPopup.classList.remove('show');
    });
    document.addEventListener('click', e=>{
      if (!langPopup) return;
      if (!langPopup.contains(e.target) && !dockLang.contains(e.target)){
        langPopup.classList.remove('show');
      }
    });
    dockMore?.addEventListener('click', (e)=>{
      e.stopPropagation();
      const navPop = document.getElementById('navPop');
      const burgerBtn = document.getElementById('burgerBtn');
      if (!navPop) return;
      const open = !navPop.classList.contains('open');
      navPop.classList.toggle('open', open);
      burgerBtn?.setAttribute('aria-expanded', String(open));
    });
    dockCart?.addEventListener('click', ()=>{
      setActiveDock(dockCart);
      openSheet();
    });
    const heroAllCats = $('#heroAllCats');
    heroAllCats?.addEventListener('click', ()=>{
      buildCatSheet();
      openCatSheet();
    });
    const heroCloseBtn = $('#heroClose');
    heroCloseBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      const closed = !document.body.classList.contains('hero-closed');
      document.body.classList.toggle('hero-closed', closed);
      localStorage.setItem(HERO_KEY, closed ? '1' : '0');
    });
    const brandEl = $('#brandTap');
    brandEl?.addEventListener('click', (e)=>{
      if (!document.body.classList.contains('island')) return;
      e.preventDefault();
      window.scrollTo({top:0, behavior:'smooth'});
    });
    const sheetClose = $('#sheetClose');
    sheetClose?.addEventListener('click', (e)=>{ e.stopPropagation(); closeSheet(); });
    const catSheetClose = $('#catSheetClose');
    catSheetClose?.addEventListener('click', (e)=>{ e.stopPropagation(); closeCatSheet(); });
    document.addEventListener('keydown', e=>{
      if (e.key === 'Escape'){
        if ($('#sheet')?.classList.contains('open')) closeSheet();
        if ($('#catSheet')?.classList.contains('open')) closeCatSheet();
        if (langPopup?.classList.contains('show')) langPopup.classList.remove('show');
      }
    });
    // Swipe-down close sheets
    (function(){
      const cartSheet = $('#sheet');
      const cartOverlay = $('#overlay');
      const catSheet = $('#catSheet');
      const catOverlay = $('#catOverlay');
      const DRAG_START_ZONE = 40;
      const DISMISS_Y = 120;
      const MAX_DRAG = 280;
      function attachSwipe(sheetEl, overlayEl, closeFn){
        if (!sheetEl) return;
        let startY = 0;
        let currentY = 0;
        let dragging = false;
        function onStart(e){
          const touch = e.touches && e.touches[0];
          if (!touch) return;
          const rect = sheetEl.getBoundingClientRect();
          const offsetY = touch.clientY - rect.top;
          if (offsetY > DRAG_START_ZONE) return;
          dragging = true;
          startY = touch.clientY;
          currentY = 0;
          sheetEl.style.transition = 'transform .0s';
          if (overlayEl) overlayEl.style.transition = 'opacity .0s';
        }
        function onMove(e){
          if (!dragging) return;
          const touch = e.touches && e.touches[0];
          if (!touch) return;
          const dy = touch.clientY - startY;
          if (dy <= 0){
            currentY = 0;
            sheetEl.style.transform = 'translateY(0)';
            if (overlayEl) overlayEl.style.opacity = '1';
            return;
          }
          currentY = Math.min(dy, MAX_DRAG);
          const progress = currentY / MAX_DRAG;
          sheetEl.style.transform = `translateY(${currentY}px)`;
          if (overlayEl) overlayEl.style.opacity = String(1 - progress * 0.7);
        }
        function onEnd(){
          if (!dragging) return;
          dragging = false;
          sheetEl.style.transition = 'transform .22s ease';
          if (overlayEl) overlayEl.style.transition = 'opacity .22s ease';
          if (currentY > DISMISS_Y){
            sheetEl.style.transform = `translateY(${MAX_DRAG}px)`;
            if (overlayEl) overlayEl.style.opacity = '0';
            setTimeout(()=>{
              sheetEl.style.transform = '';
              if (overlayEl) overlayEl.style.opacity = '';
              closeFn();
            },200);
          } else {
            sheetEl.style.transform = 'translateY(0)';
            if (overlayEl) overlayEl.style.opacity = '1';
          }
        }
        sheetEl.addEventListener('touchstart', onStart, {passive:true});
        sheetEl.addEventListener('touchmove', onMove, {passive:true});
        sheetEl.addEventListener('touchend', onEnd);
        sheetEl.addEventListener('touchcancel',onEnd);
      }
      attachSwipe(cartSheet, cartOverlay, closeSheet);
      attachSwipe(catSheet, catOverlay, closeCatSheet);
    })();
    /* Init */
    (function init(){
      loadCart();
      // Inject "Pho constructor" as the first item in Pho Soups
      try{
        const arr = menuData?.pho_soups;
        if (Array.isArray(arr) && !arr.some(x => x && x.key === 'pho_custom')){
          arr.unshift({
            key:'pho_custom',
            price: 160,
            weight: 450,
            spicy: 0,
            tags:['chef','popular'],
            translations:{
              ru:'Pho ‚Äî –°–æ–±–µ—Ä–∏ —Å–∞–º',
              ua:'Pho ‚Äî –ó–±–µ—Ä–∏ —Å–∞–º',
              vn:'Ph·ªü ‚Äî T·ª± ch·ªçn',
            },
            short:'–ë—É–ª—å–æ–Ω + –ª–∞–ø—à–∞. –í—ã–±–∏—Ä–∞–µ—à—å –º—è—Å–æ/—Ç–æ—Ñ—É/–∫—Ä–µ–≤–µ—Ç–∫–∏ –∏ –¥–æ–±–∞–≤–∫–∏.',
            options:[
              {id:'protein', title:{ru:'–ë–µ–ª–æ–∫',ua:'–ë—ñ–ª–æ–∫',vn:'ƒê·∫°m'}, required:true, multi:true, max:2,
                items:[
                  {id:'beef', label:{ru:'–ì–æ–≤—è–¥–∏–Ω–∞',ua:'–Ø–ª–æ–≤–∏—á–∏–Ω–∞',vn:'B√≤'}, price_delta:40},
                  {id:'chicken', label:{ru:'–ö—É—Ä–∏—Ü–∞',ua:'–ö—É—Ä–∏—Ü–∞',vn:'G√†'}, price_delta:30},
                  {id:'pork', label:{ru:'–°–≤–∏–Ω–∏–Ω–∞',ua:'–°–≤–∏–Ω–∏–Ω–∞',vn:'Heo'}, price_delta:30},
                  {id:'shrimp', label:{ru:'–ö—Ä–µ–≤–µ—Ç–∫–∏',ua:'–ö—Ä–µ–≤–µ—Ç–∫–∏',vn:'T√¥m'}, price_delta:50},
                  {id:'tofu', label:{ru:'–¢–æ—Ñ—É',ua:'–¢–æ—Ñ—É',vn:'ƒê·∫≠u ph·ª•'}, price_delta:20},
                ]},
              {id:'extras', title:{ru:'–î–æ–±–∞–≤–∫–∏',ua:'–î–æ–¥–∞—Ç–∫–∏',vn:'Th√™m'}, required:false, multi:true, max:5,
                items:[
                  {id:'corn', label:{ru:'–ö—É–∫—É—Ä—É–∑–∞',ua:'–ö—É–∫—É—Ä—É–¥–∑–∞',vn:'B·∫Øp'}, price_delta:15},
                  {id:'scallion', label:{ru:'–ó–µ–ª—ë–Ω—ã–π –ª—É–∫',ua:'–ó–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è',vn:'H√†nh l√°'}, price_delta:10},
                  {id:'onion', label:{ru:'–õ—É–∫',ua:'–¶–∏–±—É–ª—è',vn:'H√†nh'}, price_delta:8},
                  {id:'peanut', label:{ru:'–ê—Ä–∞—Ö–∏—Å',ua:'–ê—Ä–∞—Ö—ñ—Å',vn:'ƒê·∫≠u ph·ªông'}, price_delta:12},
                ]}
            ]
          });
        }
      }catch(e){}
      // Restore hero visibility
      const heroClosed = localStorage.getItem(HERO_KEY) === '1';
      document.body.classList.toggle('hero-closed', heroClosed);
      if (selA) selA.value = LANG;
      if (selB) selB.value = LANG;
      const flag = LANG_FLAGS[LANG] || 'üåê';
      const langFlagEl = $('#dockLangFlag');
      if (langFlagEl) langFlagEl.textContent = flag;
      setUITexts();
      const header = $('.header');
      const catNav = $('.cat-nav');
      if (header && catNav){
        catNav.style.top = `${header.offsetHeight}px`;
      }
      updateActive();
      applyView();
    })();
    </script>
  </div>
<script>
(() => {
  const dock = document.getElementById('dock');
  const lens = document.getElementById('dockLens');
  if (!dock || !lens) return;
  // –ö–Ω–æ–ø–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å <a> –∏–ª–∏ <button> ‚Äî –±–µ—Ä—ë–º –ª—é–±—ã–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  const items = [...dock.querySelectorAll('.dock-btn, a, button')].filter(el => el !== lens);
  function getActive(){
    return dock.querySelector('.is-active') || items[0];
  }
  function moveLensTo(el){
    if (!el) return;
    const rDock = dock.getBoundingClientRect();
    const rEl = el.getBoundingClientRect();
    const centerX = (rEl.left + rEl.width/2) - rDock.left;
    const size = Math.max(108, Math.min(140, rEl.width + 54)); // —á—É—Ç—å –±–æ–ª—å—à–µ –∫–Ω–æ–ø–∫–∏
    lens.style.width = size + 'px';
    lens.style.height = size + 'px';
    const x = centerX - size/2;
    lens.style.transform = `translate(${x}px, -50%)`;
  }
  // init
  requestAnimationFrame(() => moveLensTo(getActive()));
  // –ù–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º: –ø—Ä–æ—Å—Ç–æ —Å–ª—É—à–∞–µ–º –∏ –¥–≤–∏–≥–∞–µ–º –ª–∏–Ω–∑—É
  dock.addEventListener('click', (e) => {
    const target = e.target.closest('.dock-btn, a, button');
    if (!target || target === lens) return;
    // –ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞ is-active ‚Äî –æ–Ω–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç.
    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ—Å—Ç–∞–≤–∏–º is-active —Å–∞–º–∏:
    if (!dock.querySelector('.is-active')) {
      items.forEach(x => x.classList.remove('is-active'));
      target.classList.add('is-active');
    }
    moveLensTo(dock.querySelector('.is-active') || target);
  }, { passive: true });
  window.addEventListener('resize', () => moveLensTo(getActive()));
})();
</script>
</body>
</html>